name: Validate Extension

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    name: Validate Extension Files
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install web-ext
      run: npm install -g web-ext

    - name: Validate manifest.json
      run: |
        echo "Validating manifest.json..."
        if ! command -v jq &> /dev/null; then
          sudo apt-get update && sudo apt-get install -y jq
        fi
        jq empty manifest.json && echo "✓ manifest.json is valid JSON"

    - name: Check required files
      run: |
        echo "Checking required files..."
        files=("manifest.json" "content.js" "content.css" "LICENSE" "README.md" "CHANGELOG.md" "CONTRIBUTING.md" "CODE_OF_CONDUCT.md" "SECURITY.md")
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "✓ $file exists"
          else
            echo "✗ $file is missing"
            exit 1
          fi
        done

    - name: Check icon files
      run: |
        echo "Checking icon files..."
        if [ -f "icons/icon-48.svg" ] && [ -f "icons/icon-96.svg" ]; then
          echo "✓ Icons exist"
        else
          echo "✗ Icons are missing"
          exit 1
        fi

    - name: Run web-ext lint
      run: |
        echo "Running web-ext lint..."
        web-ext lint --source-dir=. --ignore-files=.github/ --ignore-files=docs/ --ignore-files=screenshots/ --ignore-files=.git/ --ignore-files=.cef/ --ignore-files="*.md"

    - name: Check file sizes
      run: |
        echo "Checking file sizes..."
        max_size=102400  # 100KB in bytes
        for file in content.js content.css; do
          size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
          if [ $size -gt $max_size ]; then
            echo "⚠ Warning: $file is larger than 100KB ($size bytes)"
          else
            echo "✓ $file size is acceptable ($size bytes)"
          fi
        done

    - name: Validate manifest fields
      run: |
        echo "Validating critical manifest fields..."
        jq -e '.manifest_version' manifest.json > /dev/null && echo "✓ manifest_version present"
        jq -e '.name' manifest.json > /dev/null && echo "✓ name present"
        jq -e '.version' manifest.json > /dev/null && echo "✓ version present"
        jq -e '.description' manifest.json > /dev/null && echo "✓ description present"
        jq -e '.author' manifest.json > /dev/null && echo "✓ author present"
        jq -e '.icons' manifest.json > /dev/null && echo "✓ icons present"
        jq -e '.permissions' manifest.json > /dev/null && echo "✓ permissions present"
        jq -e '.content_scripts' manifest.json > /dev/null && echo "✓ content_scripts present"

    - name: Summary
      run: |
        echo "✅ All validation checks passed!"
